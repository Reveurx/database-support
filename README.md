## Проект миграции StackExchange Data Dump в PostgreSQL

### Структура репозитория

Проект автоматизирует перенос схемы и данных StackExchange (dba.stackexchange.org) в PostgreSQL. Репозиторий включает:

- `1_schema_generation.py`: генерация SQL-скрипта схемы на основе XML и DDL-описаний. Учитываются только поля, реально представленные в дампе, дополненные информацией из файлов ниже.
- `1_create_tables.sql`: создание таблиц без ограничений и внешних ключей, чтобы избежать конфликтов на этапе загрузки.
- `2_data_processing.py`: загрузка данных из XML, генерация новых уникальных идентификаторов с сохранением ссылочной целостности. Обеспечивает маппинг старых ID и номеров архива.
- `2_final_constraints.sql`: создание внешних ключей, индексация, включение ограничений после загрузки данных.
- `query.sql`: демонстрация аналитических и агрегирующих запросов.
- `query_plans.md`: планы выполнения и шаги по оптимизации запросов.

### Возникавшие вопросы и решения

1. **Как определить структуру таблиц и нужные поля?**  
   Использованы официальные схемы [SEDE Schema](https://sedeschema.github.io) и анализ дампов XML. Для фильтрации полей применён парсинг реальных данных. Исходная MSSQL-схема была адаптирована к PostgreSQL.

2. **Как избежать конфликтов при создании схемы?**  
   Разделение процесса: сначала создаются таблицы (`1_create_tables.sql`), затем загружаются данные и только после этого — внешние ключи и ограничения (`2_final_constraints.sql`).

3. **Как сохранить связи между архивами?**  
   Использованы колонки `OriginalId` и `ArchiveVersion` для создания новых ключей и сохранения ссылочной целостности между таблицами.

### Оптимизация и конфигурация

- Использовалась пакетная вставка данных через pandas и psycopg2 для ускорения загрузки.
- Индексация отложена до завершения загрузки.
- В PostgreSQL включено:
  - `work_mem = 64MB`
  - `maintenance_work_mem = 512MB`
  - `effective_cache_size = 4GB`
  - `synchronous_commit = off` на этапе импорта

### Запросы и планы выполнения

Файл `query.sql` содержит выборки по популярным вопросам, активным пользователям, статистике по тегам. В `query_plans.md` представлены планы выполнения, узкие места и предложенные решения.

### Инструкции по запуску:
1. Установите PostgreSQL (рекомендуется версия 17)
2. В database-support/data/README.md указаны файлы для скачивания и информация о них.
3. Последовательно запускайте файлы, предварительно изменив реальные пути к файлам:
  - python 1_schema_generation.py
  - psql -d <db> -f 1_create_tables.sql
  - python 2_data_processing.py
  - psql -d <db> -f 2_final_constraints.sql

### Созданная структура имеет вид (кроме таблиц, содержащих только наименования - они не создаются и на них нет ссылок):
![full_database_schema](https://github.com/user-attachments/assets/b5bd35ef-75f4-4610-986e-2a67ae9ee379)

